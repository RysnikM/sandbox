<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
	<title>Опрсо модулей</title>
</head>
<body>
<div id="coils"></div>
press1
<div id="press"></div>
press2
<div id="press2"></div>
========================================
========================================
========================================
<div id="errorfs"></div>
<div id="server"></div>
</body>


<script type="text/javascript">
const utf8 = require('utf8');
 const mysql = require("mysql2");
	//mysql connection
 const connection = mysql.createConnection({
  host: "localhost",
  user: "server",
  database: "fanDOK",
  password: "z1x2c3v4"
});
	 connection.connect(function(err){
    if (err) {
       alert("Error mysql: " + err.message);
    }
    else{
      //alert("Connection OK!");
    }
 });
   function getobor(){
connection.query(
  'SELECT * FROM `oborudovanie` WHERE `type`="owen"',
  function(err, results, fields) {
   
    press.bits.table[0] = results[2].tablename;
    press.bits.table[1] = results[3].tablename;
    press.bits.table[2] = results[4].tablename;
    press.bits.table[3] = results[5].tablename;
    sushka.bits.table[0] = results[6].tablename;
    redyceh.bits.table[0]= results[0].tablename;
    redyceh.bits.table[1]= results[1].tablename;
 
   // press.bits.srez = results[2].address;

 connection.query('SELECT id,status,endperiod,parentid FROM `'+results[0].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      redyceh.bits.status[0] = results[0].status;
      redyceh.bits.lastId[0] = results[0].id;
      redyceh.bits.start[0] = results[0].endperiod;
      redyceh.bits.parent[0] = results[0].parentid; 
    });
  connection.query('SELECT id,status,endperiod,parentid FROM `'+results[1].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      redyceh.bits.status[1] = results[0].status;
      redyceh.bits.lastId[1] = results[0].id;
      redyceh.bits.start[1] = results[0].endperiod;
      redyceh.bits.parent[1] = results[0].parentid; 
    });


 connection.query('SELECT id,status,endperiod,parentid FROM `'+results[6].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      sushka.bits.status[0] = results[0].status;
      sushka.bits.lastId[0] = results[0].id;
      sushka.bits.start[0] = results[0].endperiod;
      sushka.bits.parent[0] = results[0].parentid; 
    });


    connection.query('SELECT id,status,endperiod,parentid FROM `'+results[2].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      press.bits.status[0] = results[0].status;
      press.bits.lastId[0] = results[0].id;
      press.bits.start[0] = results[0].endperiod;
      press.bits.parent[0] = results[0].parentid; 
    });
    connection.query('SELECT id,status,endperiod,parentid FROM `'+results[3].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      press.bits.status[1] = results[0].status;
      press.bits.lastId[1] = results[0].id; 
       press.bits.start[1] = results[0].endperiod;
      press.bits.parent[1] = results[0].parentid; 
    });
    connection.query('SELECT id,status,endperiod,parentid FROM `'+results[4].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      press.bits.status[2] = results[0].status;
      press.bits.lastId[2] = results[0].id;
       press.bits.start[2] = results[0].endperiod;
      press.bits.parent[2] = results[0].parentid;  
    });
    connection.query('SELECT id,status,endperiod,parentid FROM `'+results[5].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      press.bits.status[3] = results[0].status;
      press.bits.lastId[3] = results[0].id; 
       press.bits.start[3] = results[0].endperiod;
      press.bits.parent[3] = results[0].parentid; 
    });
    press.bits.notupd = false;
    // for press 2
   // press2.bits.table = results[3].tablename;
   // press2.bits.srez = results[3].address;
    
    
  }
);
}
getobor();


var countinsert=0;









   /// for modbus
function echo(err){
var json = JSON. stringify(err);
alert(json);
}

function readerr(err,id){
var json = JSON. stringify(err);
document.getElementById(id).innerHTML=json;
}
function dec2bin(dec){
    var bin = (dec >>> 0).toString(2);
    for (var i = bin.length ; i <= 32; i++) {
      bin= "0"+bin;
    }
    return bin.substr(1,16);
}
const node_modbus = require('node-modbus');
class ModbusCLient {


  constructor(host,name,srez=null,table=null,getobo) {

    this.host = host;
    this.name = name;
    this.client = node_modbus.client.tcp.complete({
    'host': this.host, /* IP or name of server host */
    'port': 502, /* well known Modbus port */
    'unitId': 1,
    'timeout': 5000, /* 2 sec */
    'autoReconnect': true, /* reconnect on connection is lost */
    'reconnectTimeout': 15000, /* wait 15 sec if auto reconnect fails to often */
    'logLabel' : 'ModbusClientTCP', /* label to identify in log files */
    'logLevel': 'debug', /* for less log use: info, warn or error */
    'logEnabled': true
})
    ////
var bits={};
bits.arr=0;
bits.status=[];
bits.statusReal=[];
bits.lastId=[];
bits.table =table;
bits.srez=srez;
bits.start=[];
bits.parent=[];
bits.notupd=false;
bits.name = this.name;
this.bits={};
this.bits=bits;
var clint = this.client;
    this.client.on('connect', function () {
  setInterval( function () { 
if(bits.srez){
  clint.readHoldingRegisters(51, 2).then(function (resp) {
    //console.log("SMA Power AC");
    bits.arr=dec2bin(resp.payload.readUInt32BE(0, 1));
    statusTCP(bits);
  }).catch(function (err) {

  })  
  }
}, 5000)
  })
    
    this.client.on('error', function (err) {
  var errCon = err;

})
    this.client.connect();
    //////
  }

  getbits() {
    alert('getbits');
    
  }

}

function statusTCP(bits){
bits.statusReal=[];
for (var i = bits.srez.length - 1; i >= 0; i--) {
  
   var arr = bits.arr.substr(-2-parseInt(bits.srez[i]),3);

    if(arr[0]==="1" && arr[2]==="1" && arr[1]==="0"){
      bits.statusReal[i] = 2;
    }else if(arr[2]==="1" && arr[0]!="1" && arr[1]!="1"){
      bits.statusReal[i] = 3;
    }else if(arr[1]==="1" && arr[2]==="1" && arr[0]!="1"){
      bits.statusReal[i] = 1;
    }else{
      bits.statusReal[i]=0;
    }
    if(parseInt(bits.statusReal[i])==parseInt(bits.status[i]) && !bits.notupd){
      var time = parseInt(Date.now()/1000);
      
      connection.query('UPDATE `'+bits.table[i]+'` SET `endperiod`='+time+' WHERE `id`='+bits.lastId[i],function(error, results, fields){
          if(error){
            alert(error);
          }
     });
      bits.start[i]=time;
    }else{
      bits.notupd = true;
      var time = parseInt(Date.now()/1000);
     
      connection.query('INSERT INTO `'+bits.table[i]+'` (`startperiod`,`endperiod`,`status`,`parentid`) VALUES ('+bits.start[i]+', '+time+','+bits.statusReal[i]+','+bits.parent[i]+');',function(error,result,fields){
        if(error){ bits.notupd= false;}
        bits.start[i]=time;
        
       bits.status[i]=bits.statusReal[i];
       getobor();
       countinsert++;
      });
    }
   // alert('UPDATE `'+bits.table[i]+'` SET `endperiod`='+time+' WHERE `id`='+bits.lastId);
}
}
var redyceh = new ModbusCLient("192.168.49.247","obrshkif",[4,1],['shlifstanok','obreznoy'],getobor());

var sushka = new ModbusCLient("192.168.49.233","sushilka",[1],['sushilka']);
var press = new ModbusCLient("192.168.49.248","press",[1,4,7,10],['press1','press2','press3','press4'],getobor());
//get.getbits();




function getplc(table=[],obj){
  for (var i = table.length - 1; i >= 0; i--) {
 connection.query('SELECT id,status,endperiod,parentid FROM `'+results[i].tablename+'` ORDER BY `id` desc LIMIT 1',function(err, results, fields){
      obj.bits.status[i] = results[i].status;
      obj.bits.lastId[i] = results[i].id;
      obj.bits.start[i] = results[i].endperiod;
      obj.bits.parent[i] = results[i].parentid; 
    });
}
}
















const node_modbus1 = require('node-modbus');
class ModbusCLientPLC {

  constructor(host,name,srez=null,table=null,getobo) {

    this.host = host;
    this.name = name;
    this.client = node_modbus1.client.tcp.complete({
    'host': this.host, /* IP or name of server host */
    'port': 502, /* well known Modbus port */
    'unitId': 1,
    'timeout': 5000, /* 2 sec */
    'autoReconnect': true, /* reconnect on connection is lost */
    'reconnectTimeout': 15000, /* wait 15 sec if auto reconnect fails to often */
    'logLabel' : 'ModbusClientTCP1', /* label to identify in log files */
    'logLevel': 'debug', /* for less log use: info, warn or error */
    'logEnabled': true
})
    ////
var bits={};
bits.arr=0;
bits.status=[];
bits.statusReal=[];
bits.lastId=[];
bits.table =table;
bits.srez=srez;
bits.start=[];
bits.parent=[];
bits.notupd=false;
bits.name = this.name;
this.bits={};
this.bits=bits;
var clint = this.client;
 // echo(this.client);
    this.client.on('connect', function () {
  setInterval( function () { 
clint.readHoldingRegisters(1, 2).then(function (resp) {
    echo(resp)
  }).catch(function (err) {
    echo(err)
  })
  
}, 10000)


  })
    
    this.client.on('error', function (err) {
  var errCon = err;
readerr(err,'coils');
})
    this.client.connect();
    //////
  }



}




var lu = new ModbusCLientPLC("192.168.49.237","press",[1,5,9],['lu_N_1','lu_N_2','lu_N_3'],getplc());



















 setInterval( function () {   
//readerr(get.bits,'coils'); 
readerr(press.bits,'press'); 



  },500)
</script>
</html>