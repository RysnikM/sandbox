<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEEotchet</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/mdb.min.css">
    <link rel="stylesheet" href="assets/css/datatables-select.min.css">
    <link rel="stylesheet" href="assets/css/datatables.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
    
    <ol class="breadcrumb  d-print-none" id="breadcrumbsID" style="background-color:#ffffff;padding-bottom:0px;">
        <li class="breadcrumb-item"><a href="/start"><span>Главная</span></a></li>
        <li class="breadcrumb-item"><a href="/start/oee"><span>ОЕЕ</span></a></li>
        <li class="breadcrumb-item active"><span>Отчеты</span></li>
    </ol>
    <div>
        <ul class="nav nav-tabs nav-fill mb-2  d-print-none">
            <li class="nav-item"><a class="nav-link active" role="tab" data-toggle="tab" href="#tab-1">Выбор данных</a></li>
            <li class="nav-item"><a class="nav-link" role="tab" data-toggle="tab" href="#tab-2">Отчет</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" role="tabpanel" id="tab-1">
                <div class="container-fluid">
                    <div class="row justify-content-center align-items-center m-auto">
                        <div class="col-auto d-flex flex-fill justify-content-center align-items-center align-content-center align-self-center mt-4">
                            <div class="form-group flex-fill">
                                <div class="form-group input-group"><select class=" form-control-lg d-flex flex-fill m-auto data-select"><option  value="ddd" selected disabled="">Выберите параметры</option>
                              <?php foreach($oborudovanie as $key => $val){  ?>
                                <option  class='qq' value="<?php echo($val['tablename']);?>"><?php echo($val['name']);?></option>

                                <?php } ?>
                                </select>
                                    <span class="input-group-btn"><button class="btn btn-success btn btn-success btn-block btn-add ml-1 btn-rounded" type="button">✚</button></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2 mt-3">
                        <div class="col-12">
                            <h4 class="text-center">Вывести данные&nbsp;</h4>
                        </div>
                        <div class="col">
                            <div class="row">
                                <div class="col-12 col-sm-12 col-md-6 d-flex flex-fill justify-content-around align-items-center align-content-center align-self-center mb-1 mt-1"><span>С &nbsp; &nbsp;&nbsp;</span><input id="startperiod" class="d-flex flex-fill" type="datetime-local" required=""></div>
                                <div class="col-12 col-sm-12 col-md-6 d-flex flex-fill justify-content-around align-items-center align-content-center mb-1 mt-1"><span>по &nbsp;&nbsp;</span><input id="endperiod" class="d-flex flex-fill" type="datetime-local" required=""></div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-2 mt-3">
                        <div class="col-12">
                            <h4 class="text-center">Период средней выборки в минутах</h4>
                        </div>
                        <div class="col">
                            <div class="row justify-content-center align-items-center">
                                <div class="col-12 col-sm-12 col-md-6 d-flex flex-fill justify-content-center align-items-center align-content-center align-self-center mb-1 mt-1"><input id="periodinterval" class="d-flex flex-grow-1 justify-content-center text-center" type="number" value="10" placeholder="Введите время" min="10" step="10"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-center mt-3">
                        <div class="col-6"><button class="btn btn-primary btn-block btn-lg btn-rounded" type="button" onclick="addselect(this);" id="showOEECharts">Создать отчет</button></div>
                    </div>
                     <div class="row justify-content-center mt-3">
                        <div class="col-6"><button class="btn btn-primary btn-block btn-lg btn-rounded" type="button" onclick="addselect(this,1);" id="showOEECharts1">Создать отчет по сменам</button></div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" role="tabpanel" id="tab-2">
                <div class="container-fluid">
                    <div class="row">
                        <div  class="col-12" id="otchetTableLost">
                            <h4 class="text-center">Цех 1 - Станок ХХ</h4>
<table id="OEEtable" class="table table-bordered table-hover table-sm text-center " cellspacing="0" width="100%">
  <thead>
    <tr>
      <th class="th-sm">№ п/п</th>
      <th class="th-sm">Начало</th>
      <th class="th-sm">Конец</th>
      <th class="th-sm">OEE</th>
      <th class="th-sm">Доступность А</th>
	  <th class="th-sm">Производительность P</th>	
    </tr>
  </thead>
  <tbody>



  </tbody>
  <tfoot>
    <tr>
       <th>№ п/п</th>
      <th colspan='2'>Период</th>
      <th>OEE</th>
      <th colspan="2">Показатели ОЕЕ</th>
    </tr>
  </tfoot>
</table></div>
                    </div>
                    <div id="prostoidrW"></div>
                </div>
            </div>
        </div>
    </div>








    <div class="container-fluid" id="padBot">
        <div style="padding-bottom:84px;"></div>
    </div>
   
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/tooltip.js"></script>
    <script src="assets/js/all.js"></script>
    <script src="assets/js/btn.js"></script>
    <script src="assets/js/moment-with-locales.js"></script>
    <script src="assets/js/highcharts.js"></script>
    <script src="assets/js/map.js"></script>
    <script src="assets/js/datatables.min.js"></script>
    <script src="assets/js/datatables-select.min.js"></script>
    <script src="assets/js/OEEchartColumn.js"></script>
</body>

</html>


<script type="text/javascript">
           //передача данных из php в html
       var name = '<?php  echo($resJson); ?>';
    var arrName = JSON.parse(name);

var arrmessages;
var oy=[];
var vals=[];
var qw=[];
var periodinterva;
  var day =moment().format('YYYY-MM-DD');
var time =moment().format('HH:mm');
var timeday=day+"T"+time;
var year = moment().format('YYYY');
  document.getElementById("startperiod").value=year+"-01-01T00:00";
document.getElementById("endperiod").value=timeday;

var namrs;
var dataForProstoi;
var namesForProstoi;

function addselect(event,qq) {
  sw=0;
  var arrsel=[];
   periodinterval=$("#periodinterval").val();
  var zapros="?tables=";
  var q; 
$(".qq:selected").each(function(){
   q = $(this).attr("value");

 arrsel.push({"tablename":q});
});
if(arrsel.length==0){
alert("Не выбран не один из агрегатов");
//event.preventDefault(); // браузер - стоять
//event.stopPropagation(); // событие - не всплывать
return;
}
//arrsel.pop();
  var i=0;

$.each(arrsel,function(a,b){
zapros+=b.tablename+"|||";
 i++;
});
 var b = Date.parse($("#startperiod").val());
 b=b/1000;
zapros+="&start="+b;
 var a = Date.parse($("#endperiod").val());
a=a/1000;
zapros+="&end="+a;
  if(event.id=="showOEECharts1"){zapros+="&count=smena"; var gav=1;}else{
zapros+="&count="+periodinterval;
}
$.ajax({
    type: "GET",
    url: "ajax.php"+zapros,

  success: function(msg){
    for (var i = 0; i < stanokArr.length; i++) {
var NameStanok=stanokArr[i];  
$("#container"+[i]).html("");

}
periodinterval=$("#periodinterval").val();
     arrmessages = JSON.parse(msg);
     stanokArr=[];
     commonArr=[];
     oy=[];
     vals=[];
     if( msg==null || !arrmessages.oee ){alert("В выбранном периоде нет данных"); return;}
var tables="";
console.log(arrmessages);
var insertProstoi="";
var insertProstoi1="";
var dataFor=new Array();
  namrs=new Array();
           dataForProstoi=new Array();
           namesForProstoi=new Array();
    $.each(arrmessages.prostoi,function(a,b){
      if(b.poPrichinam!=undefined){
          $.each(b.poPrichinam,function(c,d){
            if( namesForProstoi[sw]===undefined){namesForProstoi[sw]=[d.namePrichina]}else{
              namesForProstoi[sw].push(d.namePrichina);
            }
              if( dataForProstoi[sw]===undefined){dataForProstoi[sw]=[d.procentOfAllTime]}else{
              dataForProstoi[sw].push(d.procentOfAllTime);
            }

            if( dataFor[sw]===undefined){
              dataFor[sw]=[{"name":d.namePrichina,"y":d.procentOfAllProstoi}];
            }else{
              dataFor[sw].push({"name":d.namePrichina,"y":d.procentOfAllProstoi});
            }

           
          });
      }
          if( namesForProstoi[sw]==undefined){namesForProstoi[sw]=["Неопределенная причина"];}else{
              namesForProstoi[sw].push("Неопределенная причина");
            }
       if( dataForProstoi[sw]==undefined){dataForProstoi[sw]=[b.withoutReason.procentOfAllTime];
       }else{
              dataForProstoi[sw].push(b.withoutReason.procentOfAllTime);
            }

             if( dataFor[sw]===undefined){
              dataFor[sw]=[{"name":"неопределенная причина","y":b.withoutReason.procentOfProstoi}];
            }else{
              dataFor[sw].push({"name":"неопределенная причина","y":b.withoutReason.procentOfProstoi});
            }
console.log(dataFor);
             namrs[sw]=b.withoutReason.oborudovanie;
 insertProstoi=insertProstoi+"<div id='prostoidr"+sw+"'></div>"+"<div id='prostoicircle"+sw+"'></div>";
  sw++;
    });
      $("#prostoidrW").html(insertProstoi);
for (var i = 0; i < sw; i++) {
 DrawProstoi(namesForProstoi[i],dataForProstoi[i],namrs[i],i);
 DrowCircle(namrs[i],dataFor[i],i);
 
}
console.log(dataForProstoi);
    $.each(arrmessages.oee,function(a,b){
      tables+='<h4 class="text-center">'+b.nametab.group+'-'+ b.nametab.nameobor+'</h4>\
<table id="OEEtable'+b.nametab.group+'" class="table table-bordered table-hover table-sm text-center oeetables" cellspacing="0" width="100%">\
  <thead>\
    <tr>\
      <th class="th-sm">№ п/п</th>\
      <th class="th-sm">Начало</th>\
      <th class="th-sm">Конец</th>\
      <th class="th-sm">OEE</th>\
      <th class="th-sm">Доступность А</th>\
    <th class="th-sm">Производительность P</th>\
    </tr>\
  </thead>\
  <tbody id="obor_'+b.nametab.nameobor+'">';

oy.push(b.nametab.nameobor);
      $.each(b.graph,function(a1,b1){
  var styl="";

  // if(+b1.end.ends>= +b1.granica_alarm){var styl="class='table-danger'";}else if(+b1.end.ends< +b1.granica_alarm && +b1.end.ends>=b1.granica_mess ){var styl="class='table-warning'";}else{styl="";}
tables+="<tr>\
      <td>"+a1+"</td>\
      <td>"+moment(b1.startperiod*1000).format('lll')+"</td>\
      <td>"+moment(b1.endperiod*1000).format('lll')+"</td>\
      <td>"+b1.OEE+"</td>\
      <td>"+b1.A+"</td>\
    <td>"+b1.P+"</td>\
    </tr>";
    if(vals[b.nametab.nameobor]===undefined){
vals[b.nametab.nameobor]=[{"x":Number(b1.startperiod*1000),"y":Number(b1.OEE)}];

    }else{
vals[b.nametab.nameobor].push({"x":Number(b1.startperiod*1000),"y":Number(b1.OEE)});
}
    });
      tables+="  </tbody> <tfoot> <tr> <th>№ п/п</th> <th colspan='2'>Период</th>\
      <th>OEE</th><th colspan='2'>Показатели ОЕЕ</th> </tr></tfoot></table>";


      });

$("#otchetTableLost").html(tables);
 stanokArr=oy;
 if(gav==1){period=8*60*60*1000}else{
period=(Number(periodinterval))*60*1000;
}
commonArr=vals;

$('.oeetables').DataTable();
//$('#VibroTable2').DataTable();
$('.dataTables_length').addClass('bs-select');
DrawGraph();
showotcet();
}});

}
window.onbeforeprint = function() {
 for (var i = 0; i < sw; i++) {
   ch[i].setSize(900, 600);

     chPr[i].setSize(900, 600);
   circle[i].setSize(900, 600);
} }
window.onafterprint = function() {
 for (var i = 0; i < sw; i++) {
  ch[i].setSize(screen.width, 600);
     chPr[i].setSize(screen.width, 600);
   circle[i].setSize(screen.width, 600);
   //chart[i].setSize(screen.width, 600);
}}
</script>
<style type="text/css">
    table { page-break-inside:auto }
    div   { page-break-inside:avoid; } /* This is the key */
    thead { display:table-header-group }
    tfoot { display:table-footer-group }
</style>
